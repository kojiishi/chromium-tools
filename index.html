<!DOCTYPE html>
<title>LayoutNG test failure charts</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<style>
html, body {
  margin: 0;
  padding: 0;
}
.chart {
  width: 100%;
  height: 50vh;
}
#dir {
  height: 100vh;
}
#ui {
  position: fixed;
  right: 0;
  top: 0;
  z-index: 1;
}
</style>
<script>
google.charts.load('current', {'packages':['corechart', 'table']});
const chart_loader = new Promise((resolve, reject) => {
  google.charts.setOnLoadCallback(resolve);
});

class Data {
  constructor(url) {
    this.rs = fetch(url);
  }

  async dataTable() {
    if (this.dataTable_)
      return this.dataTable_;
    let rs = await this.rs;
    let json = await rs.json();
    await chart_loader;
    this.dataTable_ = google.visualization.arrayToDataTable(json);
    return this.dataTable_;
  }

  async data() {
    let data = await this.dataTable();
    if (document.getElementById('hasMinDate').checked) {
      let filters = [{column: 0, minValue: document.getElementById('minDate').value}];
      data = new google.visualization.DataView(data);
      data.setRows(data.getFilteredRows(filters));
    }
    return data;
  }

  drawTable(id, data) {
    let table = new google.visualization.DataTable();
    table.addColumn('string', 'Directories');
    let rowIndex = data.getNumberOfRows() - 1;
    table.addColumn('number', data.getValue(rowIndex, 0));
    let cols = data.getNumberOfColumns();
    for (let i = 1; i < cols; i++) {
      let value = data.getValue(rowIndex, i);
      if (value)
        table.addRow([data.getColumnLabel(i), value]);
    }

    let element = document.getElementById(id);
    let renderer = new google.visualization.Table(element);
    renderer.draw(table, {
      showRowNumber: true,
    });
  }

  async draw(id, title, idTable) {
    let element = document.getElementById(id);
    let renderer = new google.visualization.AreaChart(element);
    let data = await this.data();
    renderer.draw(data, {
      isStacked: true,
      title: title,
      legend: idTable ? 'none' : null,
    });

    if (idTable)
      this.drawTable(idTable, data)
  }
}

const by_failure = new Data('data/by_failure.json');
const by_dir = new Data('data/by_dir.json');

async function drawCharts() {
  await chart_loader;
  await by_failure.draw('failure', 'Failure types');
  await by_dir.draw('dir', 'Directories', 'table');
}

window.addEventListener('load', drawCharts);
window.addEventListener('resize', drawCharts);
</script>
<body>
  <div id="ui">
    <input id="hasMinDate" type="checkbox" checked onchange="drawCharts()">
    <label for="hasMinDate">From:</label>
    <input id="minDate" type="date" value="2018-01-01" onchange="drawCharts()">
  </div>
  <div id="failure" class="chart"></div>
  <div id="dir" class="chart"></div>
  <div id="table"></div>
<script>
let args = location.search;
if (args.startsWith('?from=')) {
  document.getElementById('minDate').value = args.slice(6, 16);
}
</script>
</body>
